@page "/career-guidance"
@using UWCApplicationForm.Models
@using UWCApplicationForm.Services
@inject NavigationManager Navigation
@inject CareerMatchingService CareerService
@inject CareerGuidanceStateService StateService

<PageTitle>Career Guidance - Find Your Path</PageTitle>

<!-- Header -->
<HeaderSection 
    ApplicantName=""
    ShowCloseButton="false" />

<!-- Main Container -->
<div class="container mx-auto px-4 py-8 max-w-6xl">
    
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-uwc-navy to-blue-800 rounded-lg p-8 mb-8 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold mb-4">üéì Discover Your Future Career</h1>
                <p class="text-lg md:text-xl mb-2">Based on your academic performance and interests</p>
                <p class="text-sm md:text-base text-gray-200">Get personalized career recommendations, salary insights, and study paths</p>
            </div>
            <div class="hidden md:block">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32 text-uwc-gold opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path d="M12 14l9-5-9-5-9 5 9 5z" />
                    <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" />
                </svg>
            </div>
        </div>
    </div>

    @if (currentStep == 1)
    {
        <!-- Step 1: Basic Information -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 md:p-8 mb-6 fade-in">
            <h2 class="text-2xl font-bold text-uwc-navy dark:text-uwc-gold mb-6">Step 1: Tell Us About Yourself</h2>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Your Name</label>
                    <input 
                        type="text" 
                        @bind="studentProfile.StudentName"
                        class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-uwc-gold focus:ring-2 focus:ring-uwc-gold bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        placeholder="Enter your full name" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Education Level</label>
                    <select 
                        @bind="studentProfile.CurrentLevel"
                        @bind:after="OnEducationLevelChanged"
                        class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-uwc-gold focus:ring-2 focus:ring-uwc-gold bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="@EducationLevel.PrimarySchool">Primary School (Grade 4-7)</option>
                        <option value="@EducationLevel.HighSchool">High School (Grade 8-12)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Grade</label>
                    <input 
                        type="number" 
                        @bind="studentProfile.CurrentGrade"
                        min="4" 
                        max="12"
                        class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-uwc-gold focus:ring-2 focus:ring-uwc-gold bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        placeholder="e.g., 10" />
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button 
                    @onclick="() => GoToStep(2)"
                    class="btn-primary px-8 py-3 text-lg"
                    disabled="@(!IsStep1Valid())">
                    Next: Add Subjects
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
    }
    else if (currentStep == 2)
    {
        <!-- Step 2: Subject Marks -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 md:p-8 mb-6 fade-in">
            <h2 class="text-2xl font-bold text-uwc-navy dark:text-uwc-gold mb-4">Step 2: Enter Your Subject Marks</h2>
            <p class="text-gray-600 dark:text-gray-300 mb-6">Add your latest term or year-end marks for each subject</p>
            
            <!-- Add Subject Button -->
            <div class="mb-6">
                <button 
                    @onclick="AddSubject"
                    class="btn-secondary flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Subject
                </button>
            </div>

            <!-- Subject List -->
            <div class="space-y-4 mb-6">
                @for (int i = 0; i < studentProfile.Subjects.Count; i++)
                {
                    var index = i;
                    var subject = studentProfile.Subjects[index];
                    
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="md:col-span-5">
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Subject Name</label>
                            <select 
                                @bind="subject.SubjectName"
                                @bind:after="() => OnSubjectNameChanged(index, subject.SubjectName)"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:border-uwc-gold bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                                <option value="">Select subject...</option>
                                @foreach (var subj in availableSubjects)
                                {
                                    <option value="@subj">@subj</option>
                                }
                            </select>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Mark %</label>
                            <input 
                                type="number" 
                                @bind="subject.Mark"
                                min="0" 
                                max="100"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:border-uwc-gold bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                placeholder="0-100" />
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Grade</label>
                            <input 
                                type="text" 
                                value="@GetGradeSymbol(subject.Mark)"
                                disabled
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-900 text-gray-600 dark:text-gray-400 text-center font-bold" />
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Level</label>
                            <span class="block px-3 py-2 rounded-lg text-center font-semibold @GetPerformanceClass(subject.Mark)">
                                @GetPerformanceLevel(subject.Mark)
                            </span>
                        </div>
                        
                        <div class="md:col-span-1 flex items-end">
                            <button 
                                @onclick="() => RemoveSubject(index)"
                                class="w-full px-3 py-2 bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 text-red-600 dark:text-red-300 rounded-lg transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                }
            </div>

            <!-- Summary Stats -->
            @if (studentProfile.Subjects.Count > 0)
            {
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-700 dark:to-gray-600 rounded-lg">
                    <div class="text-center">
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Total Subjects</p>
                        <p class="text-3xl font-bold text-uwc-navy dark:text-uwc-gold">@studentProfile.Subjects.Count</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Overall Average</p>
                        <p class="text-3xl font-bold text-uwc-navy dark:text-uwc-gold">@studentProfile.OverallAverage.ToString("F1")%</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Performance</p>
                        <p class="text-xl font-bold @GetPerformanceClass(studentProfile.OverallAverage)">
                            @GetPerformanceLevel(studentProfile.OverallAverage)
                        </p>
                    </div>
                </div>
            }

            <div class="mt-8 flex justify-between">
                <button 
                    @onclick="() => GoToStep(1)"
                    class="btn-secondary px-6 py-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Back
                </button>
                <button 
                    @onclick="() => GoToStep(3)"
                    class="btn-primary px-8 py-3 text-lg"
                    disabled="@(!IsStep2Valid())">
                    Next: Add Interests
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
    }
    else if (currentStep == 3)
    {
        <!-- Step 3: Interests -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 md:p-8 mb-6 fade-in">
            <h2 class="text-2xl font-bold text-uwc-navy dark:text-uwc-gold mb-4">Step 3: What Are You Interested In?</h2>
            <p class="text-gray-600 dark:text-gray-300 mb-6">Rate your interest level in these activities (1 = Not interested, 5 = Very interested)</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                @foreach (var interest in commonInterests)
                {
                    var existingInterest = studentProfile.Interests.FirstOrDefault(i => i.InterestName == interest);
                    var rating = existingInterest?.InterestLevel ?? 3;
                    
                    <div class="p-4 border-2 border-gray-200 dark:border-gray-700 rounded-lg hover:border-uwc-gold transition-all">
                        <p class="font-medium text-gray-800 dark:text-gray-200 mb-3">@interest</p>
                        <div class="flex items-center gap-2">
                            @for (int i = 1; i <= 5; i++)
                            {
                                var starValue = i;
                                <button 
                                    @onclick="() => SetInterestRating(interest, starValue)"
                                    class="text-3xl transition-all hover:scale-110">
                                    @if (starValue <= rating)
                                    {
                                        <span class="text-uwc-gold">‚≠ê</span>
                                    }
                                    else
                                    {
                                        <span class="text-gray-300 dark:text-gray-600">‚≠ê</span>
                                    }
                                </button>
                            }
                            <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">@rating/5</span>
                        </div>
                    </div>
                }
            </div>

            <div class="mt-8 flex justify-between">
                <button 
                    @onclick="() => GoToStep(2)"
                    class="btn-secondary px-6 py-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Back
                </button>
                <button 
                    @onclick="GenerateRecommendations"
                    class="btn-submit px-8 py-3 text-lg"
                    disabled="@isGenerating">
                    @if (isGenerating)
                    {
                        <svg class="animate-spin h-5 w-5 mr-2 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Generating...</span>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Get My Career Recommendations!</span>
                    }
                </button>
            </div>
        </div>
    }

    <!-- Progress Indicator -->
    <div class="flex justify-center gap-2 mt-8">
        @for (int i = 1; i <= 3; i++)
        {
            var step = i;
            <button 
                @onclick="() => GoToStep(step)"
                class="@(currentStep == step ? "w-12 h-3 bg-uwc-gold" : "w-3 h-3 bg-gray-300 dark:bg-gray-600") rounded-full transition-all">
            </button>
        }
    </div>
</div>

@code {
    private int currentStep = 1;
    private bool isGenerating = false;
    private StudentAcademicProfile studentProfile = new();
    private List<string> availableSubjects = new();
    private List<string> commonInterests = new();

    protected override void OnInitialized()
    {
        studentProfile.CurrentLevel = EducationLevel.HighSchool;
        studentProfile.CurrentGrade = 10;
        LoadAvailableSubjects();
        commonInterests = CareerDataRepository.GetCommonInterests();
    }

    private void LoadAvailableSubjects()
    {
        var subjectsByGrade = CareerDataRepository.GetCommonSubjectsByGrade();
        availableSubjects = studentProfile.CurrentLevel == EducationLevel.HighSchool 
            ? subjectsByGrade["Grade 10-12"]
            : studentProfile.CurrentGrade >= 8 
                ? subjectsByGrade["Grade 8-9"]
                : subjectsByGrade["Grade 4-7"];
    }

    private void OnEducationLevelChanged()
    {
        LoadAvailableSubjects();
        studentProfile.Subjects.Clear();
    }

    private void AddSubject()
    {
        studentProfile.Subjects.Add(new SubjectPerformance());
    }

    private void RemoveSubject(int index)
    {
        if (index >= 0 && index < studentProfile.Subjects.Count)
        {
            studentProfile.Subjects.RemoveAt(index);
        }
    }

    private void OnSubjectNameChanged(int index, string? subjectName)
    {
        if (index >= 0 && index < studentProfile.Subjects.Count && !string.IsNullOrEmpty(subjectName))
        {
            studentProfile.Subjects[index].Category = DetermineSubjectCategory(subjectName);
        }
    }

    private SubjectCategory DetermineSubjectCategory(string subjectName)
    {
        var lower = subjectName.ToLower();
        if (lower.Contains("math")) return SubjectCategory.Mathematics;
        if (lower.Contains("science") || lower.Contains("physics") || lower.Contains("chemistry") || lower.Contains("biology")) 
            return SubjectCategory.Science;
        if (lower.Contains("english") || lower.Contains("language") || lower.Contains("afrikaans")) 
            return SubjectCategory.Languages;
        if (lower.Contains("history") || lower.Contains("geography") || lower.Contains("social")) 
            return SubjectCategory.Humanities;
        if (lower.Contains("art") || lower.Contains("design") || lower.Contains("music") || lower.Contains("drama")) 
            return SubjectCategory.Arts;
        if (lower.Contains("accounting") || lower.Contains("economics") || lower.Contains("business")) 
            return SubjectCategory.Commerce;
        if (lower.Contains("technology") || lower.Contains("computer") || lower.Contains("it")) 
            return SubjectCategory.Technology;
        
        return SubjectCategory.Humanities;
    }

    private void SetInterestRating(string interest, int rating)
    {
        var existingInterest = studentProfile.Interests.FirstOrDefault(i => i.InterestName == interest);
        if (existingInterest != null)
        {
            existingInterest.InterestLevel = rating;
        }
        else
        {
            studentProfile.Interests.Add(new StudentInterest 
            { 
                InterestName = interest, 
                InterestLevel = rating,
                RelatedCategory = DetermineInterestCategory(interest)
            });
        }
    }

    private SubjectCategory DetermineInterestCategory(string interest)
    {
        var lower = interest.ToLower();
        if (lower.Contains("technology") || lower.Contains("computer")) return SubjectCategory.Technology;
        if (lower.Contains("people") || lower.Contains("helping") || lower.Contains("caring")) return SubjectCategory.Humanities;
        if (lower.Contains("creating") || lower.Contains("design") || lower.Contains("art")) return SubjectCategory.Arts;
        if (lower.Contains("numbers") || lower.Contains("data")) return SubjectCategory.Mathematics;
        if (lower.Contains("nature") || lower.Contains("animals")) return SubjectCategory.Science;
        if (lower.Contains("business")) return SubjectCategory.Commerce;
        
        return SubjectCategory.Humanities;
    }

    private string GetGradeSymbol(int mark)
    {
        if (mark >= 80) return "A";
        if (mark >= 70) return "B";
        if (mark >= 60) return "C";
        if (mark >= 50) return "D";
        if (mark >= 40) return "E";
        return "F";
    }

    private string GetPerformanceLevel(double mark)
    {
        if (mark >= 80) return "Outstanding";
        if (mark >= 70) return "Excellent";
        if (mark >= 60) return "Good";
        if (mark >= 50) return "Average";
        return "Needs Work";
    }

    private string GetPerformanceClass(double mark)
    {
        if (mark >= 80) return "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";
        if (mark >= 70) return "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";
        if (mark >= 60) return "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";
        if (mark >= 50) return "bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200";
        return "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";
    }

    private bool IsStep1Valid()
    {
        return !string.IsNullOrWhiteSpace(studentProfile.StudentName) && 
               studentProfile.CurrentGrade >= 4 && 
               studentProfile.CurrentGrade <= 12;
    }

    private bool IsStep2Valid()
    {
        return studentProfile.Subjects.Count >= 3 && 
               studentProfile.Subjects.All(s => !string.IsNullOrWhiteSpace(s.SubjectName) && s.Mark >= 0 && s.Mark <= 100);
    }

    private void GoToStep(int step)
    {
        currentStep = step;
    }

    private async Task GenerateRecommendations()
    {
        isGenerating = true;
        await Task.Delay(1500); // Simulate processing
        
        // Generate recommendations
        var recommendation = CareerService.GenerateRecommendations(studentProfile);
        
        // Store in state service
        StateService.SetProfile(studentProfile);
        StateService.SetRecommendation(recommendation);
        
        // Navigate to results
        Navigation.NavigateTo($"/career-results");
        
        isGenerating = false;
    }
}
